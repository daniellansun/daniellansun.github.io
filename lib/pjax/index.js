var forEachEls=require("./lib/foreach-els");var parseOptions=require("./lib/parse-options");var switches=require("./lib/switches");var newUid=require("./lib/uniqueid");var on=require("./lib/events/on");var trigger=require("./lib/events/trigger");var clone=require("./lib/util/clone");var contains=require("./lib/util/contains");var extend=require("./lib/util/extend");var noop=require("./lib/util/noop");var Pjax=function(t){this.state={numPendingSwitches:0,href:null,options:null};this.options=parseOptions(t);this.log("Pjax options",this.options);if(this.options.scrollRestoration&&"scrollRestoration"in history){history.scrollRestoration="manual"}this.maxUid=this.lastUid=newUid();this.parseDOM(document);on(window,"popstate",function(t){if(t.state){var e=clone(this.options);e.url=t.state.url;e.title=t.state.title;e.history=false;e.scrollPos=t.state.scrollPos;if(t.state.uid<this.lastUid){e.backward=true}else{e.forward=true}this.lastUid=t.state.uid;this.loadUrl(t.state.url,e)}}.bind(this))};Pjax.switches=switches;Pjax.prototype={log:require("./lib/proto/log"),getElements:function(t){return t.querySelectorAll(this.options.elements)},parseDOM:function(t){var e=require("./lib/proto/parse-element");forEachEls(this.getElements(t),e,this)},refresh:function(t){this.parseDOM(t||document)},reload:function(){window.location.reload()},attachLink:require("./lib/proto/attach-link"),attachForm:require("./lib/proto/attach-form"),forEachSelectors:function(t,e,o){return require("./lib/foreach-selectors").bind(this)(this.options.selectors,t,e,o)},switchSelectors:function(t,e,o,i){return require("./lib/switches-selectors").bind(this)(this.options.switches,this.options.switchesOptions,t,e,o,i)},latestChance:function(t){window.location=t},onSwitch:function(){trigger(window,"resize scroll");this.state.numPendingSwitches--;if(this.state.numPendingSwitches===0){this.afterAllSwitches()}},loadContent:function(t,e){if(typeof t!=="string"){trigger(document,"pjax:complete pjax:error",e);return}var o=document.implementation.createHTMLDocument("pjax");var i=/<html[^>]+>/gi;var s=/\s?[a-z:]+(?:=['"][^'">]+['"])*/gi;var r=t.match(i);if(r&&r.length){r=r[0].match(s);if(r.length){r.shift();r.forEach((function(t){var e=t.trim().split("=");if(e.length===1){o.documentElement.setAttribute(e[0],true)}else{o.documentElement.setAttribute(e[0],e[1].slice(1,-1))}}))}}o.documentElement.innerHTML=t;this.log("load content",o.documentElement.attributes,o.documentElement.innerHTML.length);if(document.activeElement&&contains(document,this.options.selectors,document.activeElement)){try{document.activeElement.blur()}catch(t){}}this.switchSelectors(this.options.selectors,o,document,e)},abortRequest:require("./lib/abort-request"),doRequest:require("./lib/send-request"),handleResponse:require("./lib/proto/handle-response"),loadUrl:function(t,e){e=typeof e==="object"?extend({},this.options,e):clone(this.options);this.log("load href",t,e);this.abortRequest(this.request);trigger(document,"pjax:send",e);this.request=this.doRequest(t,e,this.handleResponse.bind(this))},afterAllSwitches:function(){var t=Array.prototype.slice.call(document.querySelectorAll("[autofocus]")).pop();if(t&&document.activeElement!==t){t.focus()}this.options.selectors.forEach((function(t){forEachEls(document.querySelectorAll(t),(function(t){if(t===0);}))}));var e=this.state;if(e.options.history){if(!window.history.state){this.lastUid=this.maxUid=newUid();window.history.replaceState({url:window.location.href,title:document.title,uid:this.maxUid,scrollPos:[0,0]},document.title)}this.lastUid=this.maxUid=newUid();window.history.pushState({url:e.href,title:e.options.title,uid:this.maxUid,scrollPos:[0,0]},e.options.title,e.href)}this.forEachSelectors((function(t){this.parseDOM(t)}),this);trigger(document,"pjax:complete pjax:success",e.options);if(typeof e.options.analytics==="function"){e.options.analytics()}if(e.options.history){var o=document.createElement("a");o.href=this.state.href;if(o.hash){var i=o.hash.slice(1);i=decodeURIComponent(i);var s=0;var r=document.getElementById(i)||document.getElementsByName(i)[0];if(r){if(r.offsetParent){do{s+=r.offsetTop;r=r.offsetParent}while(r)}}window.scrollTo(0,s)}else if(e.options.scrollTo!==false){if(e.options.scrollTo.length>1){window.scrollTo(e.options.scrollTo[0],e.options.scrollTo[1])}else{window.scrollTo(0,e.options.scrollTo)}}}else if(e.options.scrollRestoration&&e.options.scrollPos){window.scrollTo(e.options.scrollPos[0],e.options.scrollPos[1])}this.state={numPendingSwitches:0,href:null,options:null}}};Pjax.isSupported=require("./lib/is-supported");if(Pjax.isSupported()){module.exports=Pjax}else{var stupidPjax=noop;for(var key in Pjax.prototype){if(Pjax.prototype.hasOwnProperty(key)&&typeof Pjax.prototype[key]==="function"){stupidPjax[key]=noop}}module.exports=stupidPjax}