<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.svg"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.svg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="h4Zye-H-4cMnH7XYgjZnzlWV66qQsrjvi1oJSwj9HRQ"><meta name="msvalidate.01" content="3EB267585E147D46D980EEEAEF29A3BE"><meta name="yandex-verification" content="70f5b7eb46d0ac08"><meta name="baidu-site-verification" content="code-ZmfQwNfOhP"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"blog.sunlan.me",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!0,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"flat"},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!0,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!0,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:-1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="概述分布式事务可以简单地分解为两部分：“分布式”与“事务”，即一种分布式系统中横跨多个服务的事务。相比传统的数据库本地事务，分布式事务受限于CAP定理，往往是一种“阉割”版的事务，因而难以满足传统事务4大特性ACID(Atomicity, Consistency, Isolation, Durability)的全部要求。 而处理分布式事务的处理方案多种多样，也各有利弊，下面将对常见几种方案进行逐一"><meta property="og:type" content="article"><meta property="og:title" content="漫谈分布式事务"><meta property="og:url" content="https://blog.sunlan.me/2022/12/27/%E6%BC%AB%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/index.html"><meta property="og:site_name" content="山風閣"><meta property="og:description" content="概述分布式事务可以简单地分解为两部分：“分布式”与“事务”，即一种分布式系统中横跨多个服务的事务。相比传统的数据库本地事务，分布式事务受限于CAP定理，往往是一种“阉割”版的事务，因而难以满足传统事务4大特性ACID(Atomicity, Consistency, Isolation, Durability)的全部要求。 而处理分布式事务的处理方案多种多样，也各有利弊，下面将对常见几种方案进行逐一"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog.sunlan.me/2022/12/27/%E6%BC%AB%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/CAP.png"><meta property="og:image" content="https://blog.sunlan.me/2022/12/27/%E6%BC%AB%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/saga-choreography.png"><meta property="og:image" content="https://blog.sunlan.me/2022/12/27/%E6%BC%AB%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/saga-orchestration.png"><meta property="article:published_time" content="2022-12-26T17:10:24.000Z"><meta property="article:modified_time" content="2025-01-04T14:36:28.675Z"><meta property="article:author" content="孙岚"><meta property="article:tag" content="Distributed Transaction"><meta property="article:tag" content="2PC"><meta property="article:tag" content="3PC"><meta property="article:tag" content="TCC"><meta property="article:tag" content="Saga"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.sunlan.me/2022/12/27/%E6%BC%AB%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/CAP.png"><link rel="canonical" href="https://blog.sunlan.me/2022/12/27/%E6%BC%AB%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>漫谈分布式事务 | 山風閣</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-1MGWXS8NRJ"></script><script>function gtag(){dataLayer.push(arguments)}CONFIG.hostname===location.hostname&&(window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-1MGWXS8NRJ"))</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?5ac3bd84e4f4831060ddf41d2d9ab1a0",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="山風閣" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h2 class="site-title">山風閣</h2><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">Daniel Sun's Tech Vision</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook/" rel="section"><i class="fa fa-comments fa-fw"></i>留言</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>RSS</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.sunlan.me/2022/12/27/%E6%BC%AB%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="孙岚"><meta itemprop="description" content="格物致知，宁静致远"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="山風閣"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">漫谈分布式事务</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-12-27 01:10:24" itemprop="dateCreated datePublished" datetime="2022-12-27T01:10:24+08:00">2022-12-27</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-01-04 22:36:28" itemprop="dateModified" datetime="2025-01-04T22:36:28+08:00">2025-01-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Distributed-System/" itemprop="url" rel="index"><span itemprop="name">Distributed System</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>3.7k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>13 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>分布式事务可以简单地分解为两部分：“分布式”与“事务”，即一种分布式系统中横跨多个服务的事务。相比传统的数据库本地事务，分布式事务受限于CAP定理，往往是一种“阉割”版的事务，因而难以满足传统事务4大特性ACID(<strong>A</strong>tomicity, <strong>C</strong>onsistency, <strong>I</strong>solation, <strong>D</strong>urability)的全部要求。 而处理分布式事务的处理方案多种多样，也各有利弊，下面将对常见几种方案进行逐一阐述。<span id="more"></span></p><p>在阐述处理方案前，先简单介绍一下CAP定理，这对理解各个方案会有一定帮助。</p><p>CAP是<strong>C</strong>onsistency（一致性）、<strong>A</strong>vailability（可用性）、<strong>P</strong>artition tolerance（分区容错性） 三个单词的首字母缩写。该定理的核心要义是：在分布式系统中，可用性、一致性、分区容错性三者只能取其二，如下图所示：<br><img data-src="CAP.png" alt="CAP定理"></p><h2 id="两阶段提交（2PC-Two-Phase-Commit）"><a href="#两阶段提交（2PC-Two-Phase-Commit）" class="headerlink" title="两阶段提交（2PC, Two-Phase Commit）"></a>两阶段提交（2PC, Two-Phase Commit）</h2><p>两阶段提交是指在网络以及数据库领域内，为了使基于分布式系统架构下的所有节点在进行事务提交时保持一致性而设计的一种演算法。通常，两阶段提交也被称为是一种协议。涉及两个阶段以及两种角色，如下表格所示：</p><table><thead><tr><th></th><th>协调者（Coordinator）</th><th>参与者（Participant）</th></tr></thead><tbody><tr><td>1. 准备阶段<br>（也叫投票阶段）</td><td>向所有参与者节点询问是否可以执行提交操作，并开始等待各参与者节点的响应</td><td>执行询问发起为止的所有事务操作，将Undo信息和Redo信息写入日志，并响应协调者节点发起的询问，反馈“完成”或“终止”</td></tr><tr><td>2.0. 提交阶段</td><td>判断参与者节点是否均反馈“完成”。若均“完成”，则表示成功，进而执行提交，否则回滚</td><td></td></tr><tr><td>2.1. 提交阶段[成功]</td><td>向所有参与者节点发出”正式提交”的请求。当收到所有参与者节点反馈的”完成”消息后，完成事务</td><td>正式完成操作，释放在整个事务期间内占用的资源，并向协调者节点发送”完成”消息</td></tr><tr><td>2.2. 提交阶段[失败]</td><td>向所有参与者节点发出”回滚操作”的请求。当收到所有参与者节点反馈的”回滚完成”消息后，取消事务</td><td>利用之前写入的Undo信息执行回滚，并释放在整个事务期间内占用的资源，并向协调者节点发送”回滚完成”消息</td></tr></tbody></table><h3 id="XA分布式事务协议"><a href="#XA分布式事务协议" class="headerlink" title="XA分布式事务协议"></a>XA分布式事务协议</h3><p>XA协议是由X/Open组织提出的分布式事务处理规范，实现了两阶段提交，被众多数据库厂商所支持。</p><p>XA协议定义了以下3种角色：</p><ul><li>应用程序（Application Program，简称AP）：定义事务边界(即事务的开始和结束)，并且在事务边界内对资源进行操作；</li><li>事务管理器（Transaction Manager，简称TM）：负责分配事务唯一标识并监控事务的执行进度、事务的提交或回滚，扮演协调者角色；</li><li>资源管理器（Resource Manager，简称RM）：提供事务分支的注册、资源的访问以及事务分支的提交等，扮演参与者角色。</li></ul><p>上述角色在这两个阶段的交互关系如下图所示，其中步骤2~5属于第一阶段，而步骤6/7属于第二阶段。</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="411px" preserveAspectRatio="none" style="width:349px;height:411px;background:#fff" version="1.1" viewBox="0 0 349 411" width="349px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="290.7344" style="stroke:#181818;stroke-width:1" width="10" x="134.5455" y="67.4297"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1" width="10" x="310.0813" y="96.5625"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1" width="10" x="310.0813" y="139.6953"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1" width="10" x="310.0813" y="182.8281"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1" width="10" x="310.0813" y="225.9609"/><rect fill="none" height="90.2031" style="stroke:#000;stroke-width:1.5" width="230.7545" x="112.2301" y="254.9609"/><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="21" x2="21" y1="36.2969" y2="376.1641"/><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="139.2301" x2="139.2301" y1="36.2969" y2="376.1641"/><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="314.178" x2="314.178" y1="36.2969" y2="376.1641"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="32.0195" x="5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="18.0195" x="12" y="24.9951">AP</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="32.0195" x="5" y="375.1641"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="18.0195" x="12" y="395.1592">AP</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="34.6309" x="122.2301" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="20.6309" x="129.2301" y="24.9951">TM</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="34.6309" x="122.2301" y="375.1641"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="20.6309" x="129.2301" y="395.1592">TM</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="35.8066" x="297.178" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="21.8066" x="304.178" y="24.9951">RM</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="35.8066" x="297.178" y="375.1641"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="21.8066" x="304.178" y="395.1592">RM</text><rect fill="#FFFFFF" height="290.7344" style="stroke:#181818;stroke-width:1" width="10" x="134.5455" y="67.4297"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1" width="10" x="310.0813" y="96.5625"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1" width="10" x="310.0813" y="139.6953"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1" width="10" x="310.0813" y="182.8281"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1" width="10" x="310.0813" y="225.9609"/><polygon fill="#181818" points="122.5455,63.4297,132.5455,67.4297,122.5455,71.4297,126.5455,67.4297" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="21.0098" x2="128.5455" y1="67.4297" y2="67.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94.5357" x="28.0098" y="62.3638">1. &#21457;&#36215;&#20840;&#23616;&#20107;&#21153;</text><polygon fill="#181818" points="298.0813,92.5625,308.0813,96.5625,298.0813,100.5625,302.0813,96.5625" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="144.5455" x2="304.0813" y1="96.5625" y2="96.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94.5357" x="151.5455" y="91.4966">2. &#24320;&#21551;&#20107;&#21153;&#20998;&#25903;</text><polygon fill="#181818" points="155.5455,106.5625,145.5455,110.5625,155.5455,114.5625,151.5455,110.5625" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2" x1="149.5455" x2="314.0813" y1="110.5625" y2="110.5625"/><polygon fill="#181818" points="298.0813,135.6953,308.0813,139.6953,298.0813,143.6953,302.0813,139.6953" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="21.0098" x2="304.0813" y1="139.6953" y2="139.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68.5357" x="28.0098" y="134.6294">3. &#25191;&#34892;&#25805;&#20316;</text><polygon fill="#181818" points="32.0098,149.6953,22.0098,153.6953,32.0098,157.6953,28.0098,153.6953" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2" x1="26.0098" x2="314.0813" y1="153.6953" y2="153.6953"/><polygon fill="#181818" points="298.0813,178.8281,308.0813,182.8281,298.0813,186.8281,302.0813,182.8281" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="144.5455" x2="304.0813" y1="182.8281" y2="182.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94.5357" x="151.5455" y="177.7622">4. &#32467;&#26463;&#20107;&#21153;&#20998;&#25903;</text><polygon fill="#181818" points="155.5455,192.8281,145.5455,196.8281,155.5455,200.8281,151.5455,196.8281" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2" x1="149.5455" x2="314.0813" y1="196.8281" y2="196.8281"/><polygon fill="#181818" points="298.0813,221.9609,308.0813,225.9609,298.0813,229.9609,302.0813,225.9609" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="144.5455" x2="304.0813" y1="225.9609" y2="225.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146.5358" x="151.5455" y="220.895">5. &#35810;&#38382;&#65306;&#25552;&#20132;&#26159;&#21542;&#24050;&#23601;&#32490;</text><polygon fill="#181818" points="155.5455,235.9609,145.5455,239.9609,155.5455,243.9609,151.5455,239.9609" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2" x1="149.5455" x2="314.0813" y1="239.9609" y2="239.9609"/><path d="M112.2301,254.9609 L176.6729,254.9609 L176.6729,262.0938 L166.6729,272.0938 L112.2301,272.0938 L112.2301,254.9609 " fill="#EEEEEE" style="stroke:#000;stroke-width:1.5"/><rect fill="none" height="90.2031" style="stroke:#000;stroke-width:1.5" width="230.7545" x="112.2301" y="254.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19.4429" x="127.2301" y="268.0278">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="65.0543" x="191.6729" y="267.1714">[&#25552;&#20132;&#24050;&#23601;&#32490;]</text><polygon fill="#181818" points="303.0813,289.2266,313.0813,293.2266,303.0813,297.2266,307.0813,293.2266" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="144.5455" x2="309.0813" y1="293.2266" y2="293.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68.5357" x="151.5455" y="288.1606">6. &#25191;&#34892;&#25552;&#20132;</text><line style="stroke:#000;stroke-width:1;stroke-dasharray:2,2" x1="112.2301" x2="342.9846" y1="302.2266" y2="302.2266"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="65.0543" x="117.2301" y="312.437">[&#25552;&#20132;&#26410;&#23601;&#32490;]</text><polygon fill="#181818" points="303.0813,333.1641,313.0813,337.1641,303.0813,341.1641,307.0813,337.1641" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="144.5455" x2="309.0813" y1="337.1641" y2="337.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68.5357" x="151.5455" y="332.0981">7. &#25191;&#34892;&#22238;&#28378;</text><polygon fill="#181818" points="32.0098,354.1641,22.0098,358.1641,32.0098,362.1641,28.0098,358.1641" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2" x1="26.0098" x2="138.5455" y1="358.1641" y2="358.1641"/></g></svg><h3 id="XA分布式事务演示"><a href="#XA分布式事务演示" class="headerlink" title="XA分布式事务演示"></a>XA分布式事务演示</h3><figure class="highlight groovy"><figcaption><span>基于H2以及Groovy4的XA演示</span><span class="exturl" data-url="aHR0cHM6Ly9nd2MtZXhwZXJpbWVudC5hcHBzcG90LmNvbQ==">Groovy Web Console<i class="fa fa-external-link-alt"></i></span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">@Grapes</span>(</span><br><span class="line">    <span class="meta">@Grab</span>(group=<span class="string">&#x27;com.h2database&#x27;</span>, module=<span class="string">&#x27;h2&#x27;</span>, version=<span class="string">&#x27;2.1.214&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext</span><br><span class="line"><span class="keyword">import</span> javax.sql.XAConnection</span><br><span class="line"><span class="keyword">import</span> javax.sql.XADataSource</span><br><span class="line"><span class="keyword">import</span> javax.transaction.xa.XAException</span><br><span class="line"><span class="keyword">import</span> javax.transaction.xa.XAResource</span><br><span class="line"><span class="keyword">import</span> javax.transaction.xa.Xid</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement</span><br><span class="line"><span class="keyword">import</span> org.h2.jdbcx.JdbcDataSource</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建资源管理器实例 rm1</span></span><br><span class="line">XADataSource xaDS1 = <span class="keyword">new</span> JdbcDataSource(<span class="attr">url:</span> <span class="string">&#x27;jdbc:h2:mem:db1&#x27;</span>, <span class="attr">user:</span> <span class="string">&#x27;sunlan&#x27;</span>, <span class="attr">password:</span> <span class="string">&#x27;123456&#x27;</span>)</span><br><span class="line">XAConnection xaConn1 = xaDS1.getXAConnection()</span><br><span class="line">Connection conn1 = xaConn1.getConnection()</span><br><span class="line">XAResource rm1 = xaConn1.getXAResource()</span><br><span class="line"><span class="keyword">try</span> (Statement ddlStmt1 = conn1.createStatement()) &#123;</span><br><span class="line">    ddlStmt1.execute(<span class="string">&quot;CREATE TABLE IF NOT EXISTS MSG(CONT VARCHAR(64))&quot;</span>)</span><br><span class="line">    ddlStmt1.execute(<span class="string">&quot;TRUNCATE TABLE MSG&quot;</span>) <span class="comment">// 确保空表以便后续验证</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建资源管理器实例 rm2</span></span><br><span class="line">XADataSource xaDS2 = <span class="keyword">new</span> JdbcDataSource(<span class="attr">url:</span> <span class="string">&#x27;jdbc:h2:mem:db2&#x27;</span>, <span class="attr">user:</span> <span class="string">&#x27;daniel&#x27;</span>, <span class="attr">password:</span> <span class="string">&#x27;123456&#x27;</span>)</span><br><span class="line">XAConnection xaConn2 = xaDS2.getXAConnection()</span><br><span class="line">Connection conn2 = xaConn2.getConnection()</span><br><span class="line">XAResource rm2 = xaConn2.getXAResource()</span><br><span class="line"><span class="keyword">try</span> (Statement ddlStmt2 = conn2.createStatement()) &#123;</span><br><span class="line">    ddlStmt2.execute(<span class="string">&quot;CREATE TABLE IF NOT EXISTS MSG(CONT VARCHAR(64))&quot;</span>)</span><br><span class="line">    ddlStmt2.execute(<span class="string">&quot;TRUNCATE TABLE MSG&quot;</span>) <span class="comment">// 确保空表以便后续验证</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">byte</span>[] genId() &#123;</span><br><span class="line">    <span class="keyword">return</span> UUID.randomUUID().toString().getBytes(<span class="string">&#x27;UTF-8&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">record SimpleXid(<span class="type">byte</span>[] globalTransactionId, <span class="type">byte</span>[] branchQualifier, <span class="type">int</span> formatId) <span class="keyword">implements</span> <span class="title class_">Xid</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="type">byte</span>[] getGlobalTransactionId() &#123;</span><br><span class="line">        <span class="keyword">return</span> globalTransactionId</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="type">byte</span>[] getBranchQualifier() &#123;</span><br><span class="line">        <span class="keyword">return</span> branchQualifier</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="type">int</span> getFormatId() &#123;</span><br><span class="line">        <span class="keyword">return</span> formatId</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AP向TM请求发起分布式事务，TM生成全局事务id</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">byte</span>[] gtrid = genId()</span><br><span class="line"><span class="comment">// ----------------------------- 开始：第一阶段（即准备阶段）-------------------------------</span></span><br><span class="line"><span class="type">int</span> formatId = <span class="number">1</span></span><br><span class="line"><span class="comment">// TM生成rm1上的事务分支id</span></span><br><span class="line">Xid xid1 = <span class="keyword">new</span> SimpleXid(gtrid, genId(), formatId)</span><br><span class="line"><span class="comment">// 执行rm1上的事务分支</span></span><br><span class="line">rm1.start(xid1, XAResource.TMNOFLAGS)</span><br><span class="line"><span class="keyword">try</span> (Statement stmt1 = conn1.createStatement()) &#123;</span><br><span class="line">    stmt1.execute(<span class="string">&quot;INSERT INTO MSG(CONT) VALUES (&#x27;hello&#x27;)&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">rm1.end(xid1, XAResource.TMSUCCESS)</span><br><span class="line"></span><br><span class="line"><span class="comment">// TM生成rm2上的事务分支id</span></span><br><span class="line">Xid xid2 = <span class="keyword">new</span> SimpleXid(gtrid, genId(), formatId)</span><br><span class="line"><span class="comment">// 执行rm2上的事务分支</span></span><br><span class="line">rm2.start(xid2, XAResource.TMNOFLAGS)</span><br><span class="line"><span class="keyword">try</span> (Statement stmt2 = conn2.createStatement()) &#123;</span><br><span class="line">    stmt2.execute(<span class="string">&quot;INSERT INTO MSG(CONT) VALUES (&#x27;hi&#x27;)&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">rm2.end(xid2, XAResource.TMSUCCESS)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 如果RM尚未准备好并希望执行回滚，则`prepare`方法将抛出`XAException`</span></span><br><span class="line">    <span class="comment">// `prepare`方法可能的返回值有：`XAResource.XA_RDONLY`或`XAResource.XA_OK`</span></span><br><span class="line">    <span class="type">int</span> rc1 = rm1.prepare(xid1)</span><br><span class="line">    <span class="type">int</span> rc2 = rm2.prepare(xid2)</span><br><span class="line"><span class="comment">// ----------------------------- 结束：第一阶段 -------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------------------- 开始：第二阶段（即提交阶段）-------------------------------</span></span><br><span class="line">    <span class="keyword">if</span> (XAResource.XA_OK == rc1 &amp;&amp; XAResource.XA_OK == rc2) &#123;</span><br><span class="line">        <span class="comment">// 所有事务分支都prepare成功，则提交所有事务分支</span></span><br><span class="line">        rm1.commit(xid1, <span class="literal">false</span>)</span><br><span class="line">        rm2.commit(xid2, <span class="literal">false</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (XAResource.XA_RDONLY == rc1 &amp;&amp; XAResource.XA_OK == rc2) &#123;</span><br><span class="line">        <span class="comment">// 第1个事务分支是只读且已提交，则只提交第2个事务分支</span></span><br><span class="line">        rm2.commit(xid2, <span class="literal">true</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (XAResource.XA_OK == rc1 &amp;&amp; XAResource.XA_RDONLY == rc2) &#123;</span><br><span class="line">        <span class="comment">// 第2个事务分支是只读且已提交，则只提交第1个事务分支</span></span><br><span class="line">        rm1.commit(xid1, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (XAException xae) &#123;</span><br><span class="line">    println <span class="string">&quot;分布式事务prepare或commit失败（[$&#123;xae.errorCode&#125;] $&#123;xae.getMessage()&#125;），执行回滚&quot;</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        rm1.rollback(xid1)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (XAException xae1) &#123;</span><br><span class="line">        println <span class="string">&quot;事务分支1回滚失败（[$&#123;xae1.errorCode&#125;] $&#123;xae1.getMessage()&#125;）&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        rm2.rollback(xid2)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (XAException xae2) &#123;</span><br><span class="line">        println <span class="string">&quot;事务分支2回滚失败（[$&#123;xae2.errorCode&#125;] $&#123;xae2.getMessage()&#125;）&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ----------------------------- 结束：第二阶段 -------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证db1上的执行结果</span></span><br><span class="line"><span class="keyword">try</span>(conn1; <span class="keyword">def</span> stmt1 = conn1.createStatement();</span><br><span class="line">    <span class="keyword">def</span> rs = stmt1.executeQuery(<span class="string">&#x27;SELECT CONT FROM MSG&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">def</span> resultList = []</span><br><span class="line">    <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">        resultList &lt;&lt; rs.getString(<span class="string">&#x27;CONT&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">assert</span> [<span class="string">&#x27;hello&#x27;</span>] == resultList</span><br><span class="line">&#125;</span><br><span class="line">xaConn1.close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证db2上的执行结果</span></span><br><span class="line"><span class="keyword">try</span>(conn2; <span class="keyword">def</span> stmt2 = conn2.createStatement();</span><br><span class="line">    <span class="keyword">def</span> rs = stmt2.executeQuery(<span class="string">&#x27;SELECT CONT FROM MSG&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">def</span> resultList = []</span><br><span class="line">    <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">        resultList &lt;&lt; rs.getString(<span class="string">&#x27;CONT&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">assert</span> [<span class="string">&#x27;hi&#x27;</span>] == resultList</span><br><span class="line">&#125;</span><br><span class="line">xaConn2.close()</span><br><span class="line"></span><br><span class="line">println <span class="string">&#x27;Done.&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h3><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="MINDMAP" height="303px" preserveAspectRatio="none" style="width:461px;height:303px;background:#fff" version="1.1" viewBox="0 0 461 303" width="461px" zoomAndPan="magnify"><defs/><g><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="89.9997" x="10" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69.9997" x="20" y="155.5889">&#20004;&#38454;&#27573;&#25552;&#20132;</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="47.9999" x="149.9997" y="48.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27.9999" x="159.9997" y="71.1436">&#20248;&#28857;</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="159.9994" x="247.9996" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="139.9994" x="257.9996" y="42.9951">&#23613;&#37327;&#20445;&#35777;&#25968;&#25454;&#24378;&#19968;&#33268;&#24615;</text><path d="M197.9996,66.2969 L207.9996,66.2969 C222.9996,66.2969 222.9996,38.1484 237.9996,38.1484 L247.9996,38.1484 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="103.9996" x="247.9996" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83.9996" x="257.9996" y="99.292">&#23454;&#29616;&#25104;&#26412;&#36739;&#20302;</text><path d="M197.9996,66.2969 L207.9996,66.2969 C222.9996,66.2969 222.9996,94.4453 237.9996,94.4453 L247.9996,94.4453 " fill="none" style="stroke:#181818;stroke-width:1"/><path d="M99.9997,150.7422 L109.9997,150.7422 C124.9997,150.7422 124.9997,66.2969 139.9997,66.2969 L149.9997,66.2969 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="47.9999" x="149.9997" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27.9999" x="159.9997" y="211.8857">&#32570;&#28857;</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="75.9998" x="247.9996" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55.9998" x="257.9996" y="155.5889">&#21516;&#27493;&#38459;&#22622;</text><path d="M197.9996,207.0391 L207.9996,207.0391 C222.9996,207.0391 222.9996,150.7422 237.9996,150.7422 L247.9996,150.7422 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="201.9992" x="247.9996" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="181.9992" x="257.9996" y="211.8857">&#21333;&#28857;&#25925;&#38556;&#65288;&#21327;&#35843;&#32773;&#21457;&#29983;&#25925;&#38556;&#65289;</text><path d="M197.9996,207.0391 L207.9996,207.0391 C222.9996,207.0391 222.9996,207.0391 237.9996,207.0391 L247.9996,207.0391 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="159.9994" x="247.9996" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="139.9994" x="257.9996" y="268.1826">&#23384;&#22312;&#25968;&#25454;&#19981;&#19968;&#33268;&#30340;&#21487;&#33021;</text><path d="M197.9996,207.0391 L207.9996,207.0391 C222.9996,207.0391 222.9996,263.3359 237.9996,263.3359 L247.9996,263.3359 " fill="none" style="stroke:#181818;stroke-width:1"/><path d="M99.9997,150.7422 L109.9997,150.7422 C124.9997,150.7422 124.9997,207.0391 139.9997,207.0391 L149.9997,207.0391 " fill="none" style="stroke:#181818;stroke-width:1"/></g></svg><h2 id="三阶段提交（3PC-Three-Phase-Commit）"><a href="#三阶段提交（3PC-Three-Phase-Commit）" class="headerlink" title="三阶段提交（3PC, Three-Phase Commit）"></a>三阶段提交（3PC, Three-Phase Commit）</h2><p>三阶段提交，是在网络及数据库的范畴下，令一个分布式系统内的所有节点能够执行事务的提交的一种分布式算法，主要是为了解决两阶段提交协议的缺点。与两阶段提交不同的是，三阶段提交是一种“非阻塞”的协议。三阶段提交在两阶段提交的第一阶段与第二阶段之间插入了一个PreCommit阶段，令原先在两阶段提交中，参与者在投票之后，由于协调者发生崩溃或错误，而导致参与者处于无法知晓是否提交或者中止的“不确定状态”所产生的可能相当长的延时问题得以解决。但鱼与熊掌不可兼得，三阶段提交需要更多的通讯次数，延迟较高，实现也较为复杂，而且在网络分区的情况下依然会出现数据不一致问题，因此三阶段提交的实际应用相对比较少。</p><h3 id="与两阶段提交的差异"><a href="#与两阶段提交的差异" class="headerlink" title="与两阶段提交的差异"></a>与两阶段提交的差异</h3><table><thead><tr><th></th><th>两阶段提交</th><th>三阶段提交</th></tr></thead><tbody><tr><td><strong>阶段划分</strong></td><td>㊀ 准备阶段<br>㊁ 提交阶段</td><td>① CanCommit<sup>对应2PC.㊀准备阶段</sup><br>② PreCommit<sup>对应2PC.㊀准备阶段</sup><em>（新增的阶段，推迟提交以确定所有参与者均知道提交的这一决定）</em><br>③ DoCommit<sup>对应2PC.㊁提交阶段</sup><em>（若参与者接收来自协调者的消息超时，则默认执行提交）</em></td></tr><tr><td><strong>超时机制</strong></td><td>只有协调者具有超时机制，而参与者则不具有超时机制</td><td>协调者和参与者都具有超时机制</td></tr><tr><td><strong>同步阻塞</strong></td><td>若参与者未及时收到协调者的消息，则一直持有事务资源并处于阻塞状态</td><td>若参与者未及时收到协调者的消息，一旦超时，则默认执行提交。虽然不阻塞，但可能会引发数据一致性问题</td></tr><tr><td><strong>单点故障</strong></td><td>协调者存在单点故障的可能，且会导致参与者长时间的同步阻塞</td><td>协调者存在单点故障的可能，但参与者的超时机制可以减少因该单点故障而导致的同步阻塞</td></tr></tbody></table><h3 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="优缺点"></a>优缺点</h3><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="MINDMAP" height="303px" preserveAspectRatio="none" style="width:433px;height:303px;background:#fff" version="1.1" viewBox="0 0 433 303" width="433px" zoomAndPan="magnify"><defs/><g><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="89.9997" x="10" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69.9997" x="20" y="155.5889">&#19977;&#38454;&#27573;&#25552;&#20132;</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="47.9999" x="149.9997" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27.9999" x="159.9997" y="99.292">&#20248;&#28857;</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="173.9993" x="247.9996" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="153.9993" x="257.9996" y="42.9951">&#23613;&#37327;&#28040;&#38500;&#21333;&#28857;&#25925;&#38556;&#30340;&#24433;&#21709;</text><path d="M197.9996,94.4453 L207.9996,94.4453 C222.9996,94.4453 222.9996,38.1484 237.9996,38.1484 L247.9996,38.1484 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="173.9993" x="247.9996" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="153.9993" x="257.9996" y="99.292">&#36229;&#26102;&#26426;&#21046;&#20943;&#23569;&#20102;&#21516;&#27493;&#38459;&#22622;</text><path d="M197.9996,94.4453 L207.9996,94.4453 C222.9996,94.4453 222.9996,94.4453 237.9996,94.4453 L247.9996,94.4453 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="159.9994" x="247.9996" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="139.9994" x="257.9996" y="155.5889">&#23613;&#37327;&#20445;&#35777;&#25968;&#25454;&#24378;&#19968;&#33268;&#24615;</text><path d="M197.9996,94.4453 L207.9996,94.4453 C222.9996,94.4453 222.9996,150.7422 237.9996,150.7422 L247.9996,150.7422 " fill="none" style="stroke:#181818;stroke-width:1"/><path d="M99.9997,150.7422 L109.9997,150.7422 C124.9997,150.7422 124.9997,94.4453 139.9997,94.4453 L149.9997,94.4453 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="47.9999" x="149.9997" y="217.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27.9999" x="159.9997" y="240.0342">&#32570;&#28857;</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="159.1245" x="247.9996" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="139.1245" x="257.9996" y="211.8857">&#30456;&#23545;&#20110;2PC&#65292;&#24615;&#33021;&#26356;&#20302;</text><path d="M197.9996,235.1875 L207.9996,235.1875 C222.9996,235.1875 222.9996,207.0391 237.9996,207.0391 L247.9996,207.0391 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="159.9994" x="247.9996" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="139.9994" x="257.9996" y="268.1826">&#23384;&#22312;&#25968;&#25454;&#19981;&#19968;&#33268;&#30340;&#21487;&#33021;</text><path d="M197.9996,235.1875 L207.9996,235.1875 C222.9996,235.1875 222.9996,263.3359 237.9996,263.3359 L247.9996,263.3359 " fill="none" style="stroke:#181818;stroke-width:1"/><path d="M99.9997,150.7422 L109.9997,150.7422 C124.9997,150.7422 124.9997,235.1875 139.9997,235.1875 L149.9997,235.1875 " fill="none" style="stroke:#181818;stroke-width:1"/></g></svg><h2 id="TCC（Try-Confirm-Cancel）"><a href="#TCC（Try-Confirm-Cancel）" class="headerlink" title="TCC（Try-Confirm/Cancel）"></a>TCC（Try-Confirm/Cancel）</h2><p>TCC取自<strong>T</strong>ry、<strong>C</strong>onfirm以及<strong>C</strong>ancel的首字母，是一种在应用层上实现的“两阶段提交”，因而对业务有一定的侵入性。此外，不同于传统的两阶段提交对数据库事务的依赖，TCC的资源锁定、提交以及回滚均需自行实现，所以事务参与者需要实现Try、Confirm以及Cancel接口，且均需实现幂等以避免重复执行产生错误。</p><table><thead><tr><th>应用层2PC</th><th>TCC</th><th>协调者（Coordinator）</th><th>参与者（Participant）</th></tr></thead><tbody><tr><td>1. 准备阶段</td><td>Try阶段</td><td>调用所有参与者的Try接口</td><td>执行Try具体逻辑：业务检查（一致性），锁定资源（准隔离性）</td></tr><tr><td>2.0. 提交阶段</td><td></td><td>判断所有的Try接口调用结果。<br>若所有调用结果均为成功，则进入Confirm阶段，否则进入Cancel阶段</td><td></td></tr><tr><td>2.1. 提交阶段[成功]</td><td>Confirm阶段</td><td>调用所有参与者的Confirm接口</td><td>执行Confirm具体逻辑：执行业务逻辑（不做业务检查且只使用Try阶段锁定的资源）</td></tr><tr><td>2.2. 提交阶段[失败]</td><td>Cancel阶段</td><td>调用所有参与者的Cancel接口</td><td>执行Cancel具体逻辑：释放Try阶段锁定的资源</td></tr></tbody></table><h3 id="TCC的异常场景"><a href="#TCC的异常场景" class="headerlink" title="TCC的异常场景"></a>TCC的异常场景</h3><h4 id="幂等问题"><a href="#幂等问题" class="headerlink" title="幂等问题"></a>幂等问题</h4><p>分布式系统中，网络异常不可避免，所以需要通过重试来完成接口调用。若Try、Confirm以及Cancel接口不支持幂等，则会造成资源的重复锁定、使用以及释放，进而引发严重的业务问题。</p><h4 id="空回滚"><a href="#空回滚" class="headerlink" title="空回滚"></a>空回滚</h4><p>参与者的Try接口响应由于网络异常使得协调者成功接收到，因而协调者发出Cancel命令进行回滚。如果此时参与者的Try接口尚未执行，却收到了Cancel接口调用请求，则导致空回滚。</p><h4 id="资源悬挂"><a href="#资源悬挂" class="headerlink" title="资源悬挂"></a>资源悬挂</h4><p>在上述“空回滚”问题的基础上，若参与者的Try接口最终成功执行了，由于晚于Cancel接口的执行，那么就会导致Try接口锁定的资源迟迟不释放，便导致了资源悬挂问题。</p><p>解决上述3个问题的方案比较简单，参与者通过事务状态跟踪表来实现一个状态机，若接口调用不符合状态机的入口状态要求，表示请求非法，则拒绝执行。</p><h3 id="优缺点-2"><a href="#优缺点-2" class="headerlink" title="优缺点"></a>优缺点</h3><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="MINDMAP" height="303px" preserveAspectRatio="none" style="width:448px;height:303px;background:#fff" version="1.1" viewBox="0 0 448 303" width="448px" zoomAndPan="magnify"><defs/><g><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="48.1025" x="10" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="28.1025" x="20" y="155.5889">TCC</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="47.9999" x="108.1025" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27.9999" x="118.1025" y="99.292">&#20248;&#28857;</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="75.9998" x="206.1024" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55.9998" x="216.1024" y="42.9951">&#24615;&#33021;&#36739;&#39640;</text><path d="M156.1024,94.4453 L166.1024,94.4453 C181.1024,94.4453 181.1024,38.1484 196.1024,38.1484 L206.1024,38.1484 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="229.9991" x="206.1024" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="209.9991" x="216.1024" y="99.292">&#36991;&#20813;&#36164;&#28304;&#30340;&#38271;&#26399;&#38145;&#23450;&#20197;&#21450;&#38459;&#22622;&#31561;&#24453;</text><path d="M156.1024,94.4453 L166.1024,94.4453 C181.1024,94.4453 181.1024,94.4453 196.1024,94.4453 L206.1024,94.4453 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="145.9995" x="206.1024" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="125.9995" x="216.1024" y="155.5889">&#20445;&#35777;&#25968;&#25454;&#26368;&#32456;&#19968;&#33268;&#24615;</text><path d="M156.1024,94.4453 L166.1024,94.4453 C181.1024,94.4453 181.1024,150.7422 196.1024,150.7422 L206.1024,150.7422 " fill="none" style="stroke:#181818;stroke-width:1"/><path d="M58.1025,150.7422 L68.1025,150.7422 C83.1025,150.7422 83.1025,94.4453 98.1025,94.4453 L108.1025,94.4453 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="47.9999" x="108.1025" y="217.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27.9999" x="118.1025" y="240.0342">&#32570;&#28857;</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="103.9996" x="206.1024" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83.9996" x="216.1024" y="211.8857">&#19994;&#21153;&#20405;&#20837;&#24615;&#24378;</text><path d="M156.1024,235.1875 L166.1024,235.1875 C181.1024,235.1875 181.1024,207.0391 196.1024,207.0391 L206.1024,207.0391 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="131.9995" x="206.1024" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="111.9995" x="216.1024" y="268.1826">&#24320;&#21457;&#21450;&#32500;&#25252;&#25104;&#26412;&#39640;</text><path d="M156.1024,235.1875 L166.1024,235.1875 C181.1024,235.1875 181.1024,263.3359 196.1024,263.3359 L206.1024,263.3359 " fill="none" style="stroke:#181818;stroke-width:1"/><path d="M58.1025,150.7422 L68.1025,150.7422 C83.1025,150.7422 83.1025,235.1875 98.1025,235.1875 L108.1025,235.1875 " fill="none" style="stroke:#181818;stroke-width:1"/></g></svg><h2 id="Saga"><a href="#Saga" class="headerlink" title="Saga"></a>Saga</h2><p>Saga是一些可交错运行的子事务集合，而这些子事务分解自一个长事务，其中的每个子事务都是一个保持数据库一致性的真实事务，并且都有对应的补偿动作以撤销子事务造成的结果。相较于TCC，免去了资源锁定阶段而直接执行子事务，若执行失败则进行恢复，从这个角度看，可以粗犷地这么理解：”Saga = TCC - T”。另外，同TCC一样，子事务的执行操作以及恢复操作也都应支持幂等。</p><h3 id="协调模式"><a href="#协调模式" class="headerlink" title="协调模式"></a>协调模式</h3><p>Saga执行事务的顺序称为Saga的协调逻辑，共有以下2种模式</p><h4 id="Choreography"><a href="#Choreography" class="headerlink" title="Choreography"></a>Choreography</h4><p>Saga参与者之间通过消息机制，订阅彼此事件以触发相应的事务操作。由于没有协调者，参与者之间需自行相互协调。该模式适用于参与者较少且无需复杂协调逻辑的场景。<br><img data-src="saga-choreography.png" alt="Choreography"></p><h4 id="Orchestration"><a href="#Orchestration" class="headerlink" title="Orchestration"></a>Orchestration</h4><p>定义一个协调者，负责参与者之间的协调工作。事务执行的命令从协调者发起，按照事务的逻辑顺序请求参与者，并接收到参与者的反馈后，协调者再向其他参与者发起调用请求。该模式适用于涉及协调逻辑较为复杂、参与者随时间推移不断添加的场景。<br><img data-src="saga-orchestration.png" alt="Orchestration"></p><h3 id="恢复策略"><a href="#恢复策略" class="headerlink" title="恢复策略"></a>恢复策略</h3><p>共有以下2种恢复策略，一种是迎难而上，而另外一种则是“打退堂鼓”。</p><h4 id="向前恢复（Forward-Recovery）"><a href="#向前恢复（Forward-Recovery）" class="headerlink" title="向前恢复（Forward Recovery）"></a>向前恢复（Forward Recovery）</h4><p>若子事务执行失败，则尝试重试，以积极主动的心态去推进分布式事务的执行。</p><p>以下图为例，当子事务T3执行失败时，T3尝试重试，成功后继续执行后续的子事务T4、T5：</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="ACTIVITY" height="352px" preserveAspectRatio="none" style="width:163px;height:352px;background:#fff" version="1.1" viewBox="0 0 163 352" width="163px" zoomAndPan="magnify"><defs/><g><ellipse cx="28.4824" cy="20" fill="#222222" rx="10" ry="10" style="stroke:#222;stroke-width:1"/><rect fill="#98FB98" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:.5" width="34.9648" x="11" y="50"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="14.9648" x="21" y="71.1387">T1</text><rect fill="#98FB98" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:.5" width="34.9648" x="11" y="103.9688"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="14.9648" x="21" y="125.1074">T2</text><path d="M65.9648,162.3555 L65.9648,170.9219 L45.9648,174.9219 L65.9648,178.9219 L65.9648,187.4883 A0,0 0 0 0 65.9648,187.4883 L151.9649,187.4883 A0,0 0 0 0 151.9649,187.4883 L151.9649,172.3555 L141.9649,162.3555 L65.9648,162.3555 A0,0 0 0 0 65.9648,162.3555 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M141.9649,162.3555 L141.9649,172.3555 L151.9649,172.3555 L141.9649,162.3555 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65.0001" x="71.9648" y="179.4224">&#22833;&#36133;&#21518;&#37325;&#35797;</text><rect fill="#FFC0CB" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:.5" width="34.9648" x="11" y="157.9375"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="14.9648" x="21" y="179.0762">T3</text><rect fill="#98FB98" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:.5" width="34.9648" x="11" y="211.9063"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="14.9648" x="21" y="233.0449">T4</text><rect fill="#98FB98" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:.5" width="34.9648" x="11" y="265.875"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="14.9648" x="21" y="287.0137">T5</text><ellipse cx="28.4824" cy="330.8438" fill="none" rx="11" ry="11" style="stroke:#222;stroke-width:1"/><ellipse cx="28.4824" cy="330.8438" fill="#222222" rx="6" ry="6" style="stroke:#222;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="28.4824" x2="28.4824" y1="30" y2="50"/><polygon fill="#181818" points="24.4824,40,28.4824,50,32.4824,40,28.4824,44" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="28.4824" x2="28.4824" y1="83.9688" y2="103.9688"/><polygon fill="#181818" points="24.4824,93.9688,28.4824,103.9688,32.4824,93.9688,28.4824,97.9688" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="28.4824" x2="28.4824" y1="137.9375" y2="157.9375"/><polygon fill="#181818" points="24.4824,147.9375,28.4824,157.9375,32.4824,147.9375,28.4824,151.9375" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="28.4824" x2="28.4824" y1="191.9063" y2="211.9063"/><polygon fill="#181818" points="24.4824,201.9063,28.4824,211.9063,32.4824,201.9063,28.4824,205.9063" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="28.4824" x2="28.4824" y1="245.875" y2="265.875"/><polygon fill="#181818" points="24.4824,255.875,28.4824,265.875,32.4824,255.875,28.4824,259.875" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="28.4824" x2="28.4824" y1="299.8438" y2="319.8438"/><polygon fill="#181818" points="24.4824,309.8438,28.4824,319.8438,32.4824,309.8438,28.4824,313.8438" style="stroke:#181818;stroke-width:1"/></g></svg><h4 id="向后恢复（Backward-Recovery）"><a href="#向后恢复（Backward-Recovery）" class="headerlink" title="向后恢复（Backward Recovery）"></a>向后恢复（Backward Recovery）</h4><p>若子事务执行失败，则尝试撤销，针对已执行完成的子事务，按照由近及远的顺序逐一撤销，以消除部分已执行的子事务所造成的影响。</p><p>以下图为例，当子事务T3执行失败时，依次撤销T3、T2、T1子事务所做的操作：</p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="ACTIVITY" height="406px" preserveAspectRatio="none" style="width:190px;height:406px;background:#fff" version="1.1" viewBox="0 0 190 406" width="190px" zoomAndPan="magnify"><defs/><g><ellipse cx="29.0068" cy="20" fill="#222222" rx="10" ry="10" style="stroke:#222;stroke-width:1"/><rect fill="#98FB98" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:.5" width="34.9648" x="11.5244" y="50"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="14.9648" x="21.5244" y="71.1387">T1</text><rect fill="#98FB98" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:.5" width="34.9648" x="11.5244" y="103.9688"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="14.9648" x="21.5244" y="125.1074">T2</text><path d="M66.4893,162.3555 L66.4893,170.9219 L46.4893,174.9219 L66.4893,178.9219 L66.4893,187.4883 A0,0 0 0 0 66.4893,187.4883 L178.4894,187.4883 A0,0 0 0 0 178.4894,187.4883 L178.4894,172.3555 L168.4894,162.3555 L66.4893,162.3555 A0,0 0 0 0 66.4893,162.3555 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M168.4894,162.3555 L168.4894,172.3555 L178.4894,172.3555 L168.4894,162.3555 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91.0001" x="72.4893" y="179.4224">&#22833;&#36133;&#21518;&#36880;&#19968;&#25764;&#38144;</text><rect fill="#FFC0CB" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:.5" width="34.9648" x="11.5244" y="157.9375"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="14.9648" x="21.5244" y="179.0762">T3</text><path d="M67.0137,216.3242 L67.0137,224.8906 L47.0137,228.8906 L67.0137,232.8906 L67.0137,241.457 A0,0 0 0 0 67.0137,241.457 L130.2256,241.457 A0,0 0 0 0 130.2256,241.457 L130.2256,226.3242 L120.2256,216.3242 L67.0137,216.3242 A0,0 0 0 0 67.0137,216.3242 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M120.2256,216.3242 L120.2256,226.3242 L130.2256,226.3242 L120.2256,216.3242 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="42.2119" x="73.0137" y="233.3911">&#25764;&#38144;T3</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:.5" width="36.0137" x="11" y="211.9063"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="16.0137" x="21" y="233.0449">C3</text><path d="M67.0137,270.293 L67.0137,278.8594 L47.0137,282.8594 L67.0137,286.8594 L67.0137,295.4258 A0,0 0 0 0 67.0137,295.4258 L130.2256,295.4258 A0,0 0 0 0 130.2256,295.4258 L130.2256,280.293 L120.2256,270.293 L67.0137,270.293 A0,0 0 0 0 67.0137,270.293 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M120.2256,270.293 L120.2256,280.293 L130.2256,280.293 L120.2256,270.293 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="42.2119" x="73.0137" y="287.3599">&#25764;&#38144;T2</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:.5" width="36.0137" x="11" y="265.875"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="16.0137" x="21" y="287.0137">C2</text><path d="M67.0137,324.2617 L67.0137,332.8281 L47.0137,336.8281 L67.0137,340.8281 L67.0137,349.3945 A0,0 0 0 0 67.0137,349.3945 L130.2256,349.3945 A0,0 0 0 0 130.2256,349.3945 L130.2256,334.2617 L120.2256,324.2617 L67.0137,324.2617 A0,0 0 0 0 67.0137,324.2617 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M120.2256,324.2617 L120.2256,334.2617 L130.2256,334.2617 L120.2256,324.2617 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="42.2119" x="73.0137" y="341.3286">&#25764;&#38144;T1</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:.5" width="36.0137" x="11" y="319.8438"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="16.0137" x="21" y="340.9824">C1</text><ellipse cx="29.0068" cy="384.8125" fill="none" rx="11" ry="11" style="stroke:#222;stroke-width:1"/><ellipse cx="29.0068" cy="384.8125" fill="#222222" rx="6" ry="6" style="stroke:#222;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="29.0068" x2="29.0068" y1="30" y2="50"/><polygon fill="#181818" points="25.0068,40,29.0068,50,33.0068,40,29.0068,44" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="29.0068" x2="29.0068" y1="83.9688" y2="103.9688"/><polygon fill="#181818" points="25.0068,93.9688,29.0068,103.9688,33.0068,93.9688,29.0068,97.9688" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="29.0068" x2="29.0068" y1="137.9375" y2="157.9375"/><polygon fill="#181818" points="25.0068,147.9375,29.0068,157.9375,33.0068,147.9375,29.0068,151.9375" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="29.0068" x2="29.0068" y1="191.9063" y2="211.9063"/><polygon fill="#181818" points="25.0068,201.9063,29.0068,211.9063,33.0068,201.9063,29.0068,205.9063" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="29.0068" x2="29.0068" y1="245.875" y2="265.875"/><polygon fill="#181818" points="25.0068,255.875,29.0068,265.875,33.0068,255.875,29.0068,259.875" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="29.0068" x2="29.0068" y1="299.8438" y2="319.8438"/><polygon fill="#181818" points="25.0068,309.8438,29.0068,319.8438,33.0068,309.8438,29.0068,313.8438" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="29.0068" x2="29.0068" y1="353.8125" y2="373.8125"/><polygon fill="#181818" points="25.0068,363.8125,29.0068,373.8125,33.0068,363.8125,29.0068,367.8125" style="stroke:#181818;stroke-width:1"/></g></svg><h3 id="优缺点-3"><a href="#优缺点-3" class="headerlink" title="优缺点"></a>优缺点</h3><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="MINDMAP" height="303px" preserveAspectRatio="none" style="width:426px;height:303px;background:#fff" version="1.1" viewBox="0 0 426 303" width="426px" zoomAndPan="magnify"><defs/><g><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="54.9316" x="10" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="34.9316" x="20" y="155.5889">Saga</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="47.9999" x="114.9316" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27.9999" x="124.9316" y="99.292">&#20248;&#28857;</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="201.9992" x="212.9315" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="181.9992" x="222.9315" y="42.9951">&#19968;&#38454;&#27573;&#25552;&#20132;&#23376;&#20107;&#21153;&#65292;&#24615;&#33021;&#36739;&#39640;</text><path d="M162.9315,94.4453 L172.9315,94.4453 C187.9315,94.4453 187.9315,38.1484 202.9315,38.1484 L212.9315,38.1484 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="173.9993" x="212.9315" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="153.9993" x="222.9315" y="99.292">&#21442;&#19982;&#32773;&#24322;&#27493;&#25191;&#34892;&#65292;&#21534;&#21520;&#39640;</text><path d="M162.9315,94.4453 L172.9315,94.4453 C187.9315,94.4453 187.9315,94.4453 202.9315,94.4453 L212.9315,94.4453 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="131.9995" x="212.9315" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="111.9995" x="222.9315" y="155.5889">&#34917;&#20607;&#25805;&#20316;&#26131;&#20110;&#23454;&#29616;</text><path d="M162.9315,94.4453 L172.9315,94.4453 C187.9315,94.4453 187.9315,150.7422 202.9315,150.7422 L212.9315,150.7422 " fill="none" style="stroke:#181818;stroke-width:1"/><path d="M64.9316,150.7422 L74.9316,150.7422 C89.9316,150.7422 89.9316,94.4453 104.9316,94.4453 L114.9316,94.4453 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="47.9999" x="114.9316" y="217.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27.9999" x="124.9316" y="240.0342">&#32570;&#28857;</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="103.9996" x="212.9315" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83.9996" x="222.9315" y="211.8857">&#19994;&#21153;&#20405;&#20837;&#24615;&#24378;</text><path d="M162.9315,235.1875 L172.9315,235.1875 C187.9315,235.1875 187.9315,207.0391 202.9315,207.0391 L212.9315,207.0391 " fill="none" style="stroke:#181818;stroke-width:1"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5" width="103.9996" x="212.9315" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="83.9996" x="222.9315" y="268.1826">&#19981;&#20445;&#35777;&#38548;&#31163;&#24615;</text><path d="M162.9315,235.1875 L172.9315,235.1875 C187.9315,235.1875 187.9315,263.3359 202.9315,263.3359 L212.9315,263.3359 " fill="none" style="stroke:#181818;stroke-width:1"/><path d="M64.9316,150.7422 L74.9316,150.7422 C89.9316,150.7422 89.9316,235.1875 104.9316,235.1875 L114.9316,235.1875 " fill="none" style="stroke:#181818;stroke-width:1"/></g></svg><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="Notes.on.Data.Base.Operating.Systems.pdf">Notes on Data Base Operating Systems</a></li><li><a href="NonBlocking.Commit.Protocols.pdf">NonBlocking Commit Protocols</a></li><li><a href="Life.beyond.Distributed.Transactions%EF%BC%9Aan.Apostate%E2%80%99s.Opinion.pdf">Life beyond Distributed Transactions: an Apostate’s Opinion</a></li><li><a href="SAGAS.pdf">SAGAS</a></li></ul></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>孙岚</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://blog.sunlan.me/2022/12/27/%E6%BC%AB%E8%B0%88%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" title="漫谈分布式事务">https://blog.sunlan.me/2022/12/27/漫谈分布式事务/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Distributed-Transaction/" rel="tag"># Distributed Transaction</a> <a href="/tags/2PC/" rel="tag"># 2PC</a> <a href="/tags/3PC/" rel="tag"># 3PC</a> <a href="/tags/TCC/" rel="tag"># TCC</a> <a href="/tags/Saga/" rel="tag"># Saga</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2021/12/11/Groovy-4%E4%B9%8B%E6%96%B0%E7%89%B9%E6%80%A7%E9%A2%84%E8%A7%88/" rel="prev" title="Groovy 4之新特性预览"><i class="fa fa-chevron-left"></i> Groovy 4之新特性预览</a></div><div class="post-nav-item"><a href="/2023/01/14/JVM-Bytecode%E4%B9%8Binvokedynamic%E6%BC%AB%E8%B0%88/" rel="next" title="JVM Bytecode之invokedynamic漫谈">JVM Bytecode之invokedynamic漫谈 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="gitalk-container"></div><script>window.addEventListener("tabs:register",()=>{let t=CONFIG.comments["activeClass"];var e;(t=CONFIG.comments.storage?localStorage.getItem("comments_active")||t:t)&&(e=document.querySelector(`a[href="#comment-${t}"]`))&&e.click()}),CONFIG.comments.storage&&window.addEventListener("tabs:click",t=>{t.target.matches(".tabs-comment .tab-content .tab-pane")&&(t=t.target.classList[1],localStorage.setItem("comments_active",t))})</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%EF%BC%882PC-Two-Phase-Commit%EF%BC%89"><span class="nav-number">2.</span> <span class="nav-text">两阶段提交（2PC, Two-Phase Commit）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#XA%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%AE%AE"><span class="nav-number">2.1.</span> <span class="nav-text">XA分布式事务协议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XA%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%BC%94%E7%A4%BA"><span class="nav-number">2.2.</span> <span class="nav-text">XA分布式事务演示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-number">2.3.</span> <span class="nav-text">优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%EF%BC%883PC-Three-Phase-Commit%EF%BC%89"><span class="nav-number">3.</span> <span class="nav-text">三阶段提交（3PC, Three-Phase Commit）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E7%9A%84%E5%B7%AE%E5%BC%82"><span class="nav-number">3.1.</span> <span class="nav-text">与两阶段提交的差异</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-1"><span class="nav-number">3.2.</span> <span class="nav-text">优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TCC%EF%BC%88Try-Confirm-Cancel%EF%BC%89"><span class="nav-number">4.</span> <span class="nav-text">TCC（Try-Confirm&#x2F;Cancel）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TCC%E7%9A%84%E5%BC%82%E5%B8%B8%E5%9C%BA%E6%99%AF"><span class="nav-number">4.1.</span> <span class="nav-text">TCC的异常场景</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B9%82%E7%AD%89%E9%97%AE%E9%A2%98"><span class="nav-number">4.1.1.</span> <span class="nav-text">幂等问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A9%BA%E5%9B%9E%E6%BB%9A"><span class="nav-number">4.1.2.</span> <span class="nav-text">空回滚</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E6%82%AC%E6%8C%82"><span class="nav-number">4.1.3.</span> <span class="nav-text">资源悬挂</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-2"><span class="nav-number">4.2.</span> <span class="nav-text">优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Saga"><span class="nav-number">5.</span> <span class="nav-text">Saga</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%8F%E8%B0%83%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.1.</span> <span class="nav-text">协调模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Choreography"><span class="nav-number">5.1.1.</span> <span class="nav-text">Choreography</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Orchestration"><span class="nav-number">5.1.2.</span> <span class="nav-text">Orchestration</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%81%A2%E5%A4%8D%E7%AD%96%E7%95%A5"><span class="nav-number">5.2.</span> <span class="nav-text">恢复策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%91%E5%89%8D%E6%81%A2%E5%A4%8D%EF%BC%88Forward-Recovery%EF%BC%89"><span class="nav-number">5.2.1.</span> <span class="nav-text">向前恢复（Forward Recovery）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%91%E5%90%8E%E6%81%A2%E5%A4%8D%EF%BC%88Backward-Recovery%EF%BC%89"><span class="nav-number">5.2.2.</span> <span class="nav-text">向后恢复（Backward Recovery）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-3"><span class="nav-number">5.3.</span> <span class="nav-text">优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">6.</span> <span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="孙岚" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">孙岚</p><div class="site-description" itemprop="description">格物致知，宁静致远</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">25</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">75</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RhbmllbGxhbnN1bg==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;daniellansun"><i class="fab fa-github fa-fw"></i>GitHub</span> </span><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9kYW5pZWxfc3Vu" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;daniel_sun"><i class="fab fa-twitter fa-fw"></i>Twitter</span></span></div><div class="cc-license motion-element" itemprop="license"><span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC8="><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">孙岚</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span title="站点总字数">45k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">2:42</span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/fancybox/jquery.min.js"></script><script src="/lib/fancybox/jquery.fancybox.min.js"></script><script src="/lib/lazyload/lozad.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>!function(){var e,t,o,n,r=document.getElementsByTagName("link");if(0<r.length)for(i=0;i<r.length;i++)"canonical"==r[i].rel.toLowerCase()&&r[i].href&&(e=r[i].href);t=(e||window.location.protocol).split(":")[0],e=e||window.location.href,window,o=e,n=document.referrer,/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi.test(o)||(t="https"===String(t).toLowerCase()?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif",n?(t+="?r="+encodeURIComponent(document.referrer),o&&(t+="&l="+o)):o&&(t+="?l="+o),(new Image).src=t)}()</script><script src="/js/local-search.js"></script><script>document.querySelectorAll(".pdfobject-container").forEach(e=>{var t=e.dataset.target,a="#"+Object.entries({navpanes:0,toolbar:0,statusbar:0,pagemode:"thumbs",view:"FitH"}).map(([e,t])=>e+"="+encodeURIComponent(t)).join("&"),r="/lib/pdf/web/viewer.html?file="+encodeURIComponent(t)+a;NexT.utils.supportsPDFs()?e.innerHTML=`<embed class="pdfobject" src="${t+a}" type="application/pdf" style="height: ${e.dataset.height};">`:e.innerHTML=`<iframe src="${r}" style="height: ${e.dataset.height};" frameborder="0"></iframe>`})</script><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><script>NexT.utils.loadComments(document.querySelector("#gitalk-container"),()=>{NexT.utils.getScript("/lib/gitalk/gitalk.min.js",()=>{new Gitalk({clientID:"df78583b9a95e53afbe4",clientSecret:"293b9a1c1996f0b05efbf10cac455af14cd2471f",repo:"daniellansun.github.io",owner:"daniellansun",admin:["daniellansun"],id:"04f03556caef9fe696f87f2d205d3a7c",language:"zh-CN",distractionFreeMode:!0}).render("gitalk-container")},window.Gitalk)})</script></body></html>