document.addEventListener("DOMContentLoaded",(()=>{let e=false;let t;let n=true;let r=CONFIG.path;if(r.length===0){r="search.xml"}else if(r.endsWith("json")){n=false}const l=document.querySelector(".search-input");const o=document.getElementById("search-result");const s=(e,t,n)=>{if(CONFIG.localsearch.unescape){let t=document.createElement("div");t.innerText=e;e=t.innerHTML}let r=e.length;if(r===0)return[];let l=0;let o=[];let s=[];if(!n){t=t.toLowerCase();e=e.toLowerCase()}while((o=t.indexOf(e,l))>-1){s.push({position:o,word:e});l=o+r}return s};const i=(e,t,n,r)=>{let l=n[n.length-1];let{position:o,word:s}=l;let i=[];let c=0;while(o+s.length<=t&&n.length!==0){if(s===r){c++}i.push({position:o,length:s.length});let e=o+s.length;n.pop();while(n.length!==0){l=n[n.length-1];o=l.position;s=l.word;if(e>o){n.pop()}else{break}}}return{hits:i,start:e,end:t,searchTextCount:c}};const c=(e,t)=>{let n="";let r=t.start;t.hits.forEach((t=>{n+=e.substring(r,t.position);let l=t.position+t.length;n+=`<b class="search-keyword">${e.substring(t.position,l)}</b>`;r=l}));n+=e.substring(r,t.end);return n};const a=()=>{if(!e)return;let n=l.value.trim().toLowerCase();let r=n.split(/[-\s]+/);if(r.length>1){r.push(n)}let a=[];if(n.length>0){t.forEach((({title:e,content:t,url:l})=>{let o=e.toLowerCase();let h=t.toLowerCase();let u=[];let d=[];let p=0;r.forEach((e=>{u=u.concat(s(e,o,false));d=d.concat(s(e,h,false))}));if(u.length>0||d.length>0){let r=u.length+d.length;[u,d].forEach((e=>{e.sort(((e,t)=>{if(t.position!==e.position){return t.position-e.position}return e.word.length-t.word.length}))}));let o=[];if(u.length!==0){let t=i(0,e.length,u,n);p+=t.searchTextCountInSlice;o.push(t)}let s=[];while(d.length!==0){let e=d[d.length-1];let{position:r,word:l}=e;let o=r-20;let c=r+80;if(o<0){o=0}if(c<r+l.length){c=r+l.length}if(c>t.length){c=t.length}let a=i(o,c,d,n);p+=a.searchTextCountInSlice;s.push(a)}s.sort(((e,t)=>{if(e.searchTextCount!==t.searchTextCount){return t.searchTextCount-e.searchTextCount}else if(e.hits.length!==t.hits.length){return t.hits.length-e.hits.length}return e.start-t.start}));let h=parseInt(CONFIG.localsearch.top_n_per_article,10);if(h>=0){s=s.slice(0,h)}let f="";if(o.length!==0){f+=`<li><a href="${l}" class="search-result-title">${c(e,o[0])}</a>`}else{f+=`<li><a href="${l}" class="search-result-title">${e}</a>`}s.forEach((e=>{f+=`<a href="${l}"><p class="search-result">${c(t,e)}...</p></a>`}));f+="</li>";a.push({item:f,id:a.length,hitCount:r,searchTextCount:p})}}))}if(r.length===1&&r[0]===""){o.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'}else if(a.length===0){o.innerHTML='<div id="no-result"><i class="far fa-frown fa-5x"></i></div>'}else{a.sort(((e,t)=>{if(e.searchTextCount!==t.searchTextCount){return t.searchTextCount-e.searchTextCount}else if(e.hitCount!==t.hitCount){return t.hitCount-e.hitCount}return t.id-e.id}));o.innerHTML=`<ul class="search-result-list">${a.map((e=>e.item)).join("")}</ul>`;window.pjax&&window.pjax.refresh(o)}};const h=()=>{fetch(CONFIG.root+r).then((e=>e.text())).then((r=>{e=true;t=n?[...(new DOMParser).parseFromString(r,"text/xml").querySelectorAll("entry")].map((e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent}))):JSON.parse(r);t=t.filter((e=>e.title)).map((e=>{e.title=e.title.trim();e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"";e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/");return e}));document.getElementById("no-result").innerHTML='<i class="fa fa-search fa-5x"></i>';a()}))};if(CONFIG.localsearch.preload){h()}if(CONFIG.localsearch.trigger==="auto"){l.addEventListener("input",a)}else{document.querySelector(".search-icon").addEventListener("click",a);l.addEventListener("keypress",(e=>{if(e.key==="Enter"){a()}}))}document.querySelectorAll(".popup-trigger").forEach((t=>{t.addEventListener("click",(()=>{document.body.style.overflow="hidden";document.querySelector(".search-pop-overlay").classList.add("search-active");l.focus();if(!e)h()}))}));const u=()=>{document.body.style.overflow="";document.querySelector(".search-pop-overlay").classList.remove("search-active")};document.querySelector(".search-pop-overlay").addEventListener("click",(e=>{if(e.target===document.querySelector(".search-pop-overlay")){u()}}));document.querySelector(".popup-btn-close").addEventListener("click",u);window.addEventListener("pjax:success",u);window.addEventListener("keyup",(e=>{if(e.key==="Escape"){u()}}))}));